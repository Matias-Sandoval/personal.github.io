<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstadÃ­sticas | Aparicio Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--color-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 9999;
            transition: opacity .3s ease
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <p>Cargando estadÃ­sticas...</p>
    </div>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-logo"><span class="admin-logo-icon">ğŸ¥¤</span><span>Aparicio</span></div>
            <nav>
                <ul class="admin-nav">
                    <li class="admin-nav-item"><a href="dashboard.html" class="admin-nav-link">ğŸ“Š Dashboard</a></li>
                    <li class="admin-nav-item"><a href="products.html" class="admin-nav-link">ğŸ“¦ Productos</a></li>
                    <li class="admin-nav-item"><a href="orders.html" class="admin-nav-link">ğŸ“‹ Pedidos</a></li>
                    <li class="admin-nav-item"><a href="stats.html" class="admin-nav-link active">ğŸ“ˆ EstadÃ­sticas</a>
                    </li>
                    <li class="admin-nav-item"
                        style="margin-top:auto;padding-top:20px;border-top:1px solid rgba(255,255,255,.1)"><a
                            href="../index.html" class="admin-nav-link">ğŸ  Ver Tienda</a></li>
                    <li class="admin-nav-item"><a href="#" class="admin-nav-link" id="logout-btn">ğŸšª Cerrar SesiÃ³n</a>
                    </li>
                </ul>
            </nav>
        </aside>
        <main class="admin-main">
            <div class="admin-header">
                <h1 class="admin-title">EstadÃ­sticas</h1>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon green">ğŸ’°</div>
                    <div class="stat-info">
                        <h3>Ventas Totales</h3>
                        <p class="stat-value" id="total-sales">$0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon blue">ğŸ“¦</div>
                    <div class="stat-info">
                        <h3>Total Pedidos</h3>
                        <p class="stat-value" id="total-orders">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon yellow">ğŸ“Š</div>
                    <div class="stat-info">
                        <h3>Ticket Promedio</h3>
                        <p class="stat-value" id="avg-ticket">$0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red">ğŸ†</div>
                    <div class="stat-info">
                        <h3>Productos</h3>
                        <p class="stat-value" id="total-products">0</p>
                    </div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
                <div style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.1)">
                    <h3>ğŸ“ˆ Ventas de la Semana</h3><canvas id="sales-chart"></canvas>
                </div>
                <div style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.1)">
                    <h3>ğŸ“Š Pedidos por Estado</h3><canvas id="status-chart"></canvas>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
                <div style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.1)">
                    <h3>ğŸ† MÃ¡s Vendidos</h3>
                    <div id="top-products"></div>
                </div>
                <div style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.1)">
                    <h3>ğŸ“‚ Por CategorÃ­a</h3><canvas id="category-chart"></canvas>
                </div>
            </div>
        </main>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../js/data.js"></script>
    <script>
        if (!isAdminAuthenticated()) window.location.href = 'index.html';
        document.getElementById('logout-btn').onclick = e => { e.preventDefault(); adminLogout(); window.location.href = 'index.html' };
        async function loadStats() {
            const stats = await getStats(), orders = await getOrders(), products = await getProducts();
            document.getElementById('total-sales').textContent = formatPrice(stats.totalSales);
            document.getElementById('total-orders').textContent = stats.totalOrders;
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('avg-ticket').textContent = formatPrice(stats.totalOrders ? stats.totalSales / stats.totalOrders : 0);
            new Chart(document.getElementById('sales-chart'), { type: 'line', data: { labels: stats.salesByDay.map(d => d.date), datasets: [{ label: 'Ventas', data: stats.salesByDay.map(d => d.sales), borderColor: '#0891b2', backgroundColor: 'rgba(8,145,178,.1)', fill: true, tension: .4 }] }, options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
            const sc = { pending: orders.filter(o => o.status === 'pending').length, processing: orders.filter(o => o.status === 'processing').length, delivered: orders.filter(o => o.status === 'delivered').length, cancelled: orders.filter(o => o.status === 'cancelled').length };
            new Chart(document.getElementById('status-chart'), { type: 'doughnut', data: { labels: ['Pendientes', 'En Proceso', 'Entregados', 'Cancelados'], datasets: [{ data: [sc.pending, sc.processing, sc.delivered, sc.cancelled], backgroundColor: ['#f59e0b', '#6366f1', '#22c55e', '#ef4444'] }] }, options: { plugins: { legend: { position: 'bottom' } } } });
            const tp = document.getElementById('top-products');
            tp.innerHTML = stats.topProducts.length ? stats.topProducts.map((p, i) => `<div style="padding:8px 0;border-bottom:1px solid #eee"><b>#${i + 1}</b> ${p.name} - ${p.quantity} uds (${formatPrice(p.revenue)})</div>`).join('') : '<p>No hay ventas aÃºn</p>';
            const cs = {}; orders.forEach(o => { if (o.status !== 'cancelled') o.items.forEach(i => { const pr = products.find(p => p.id === i.productId); if (pr) { cs[pr.category] = (cs[pr.category] || 0) + i.subtotal } }) });
            new Chart(document.getElementById('category-chart'), { type: 'bar', data: { labels: Object.keys(cs).map(c => c.charAt(0).toUpperCase() + c.slice(1)), datasets: [{ data: Object.values(cs), backgroundColor: ['#0891b2', '#6366f1', '#22c55e', '#f59e0b', '#ef4444'] }] }, options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
            document.getElementById('loading').classList.add('hidden')
        }
        loadStats()
    </script>
</body>

</html>