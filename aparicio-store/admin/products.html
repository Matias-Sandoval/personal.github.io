<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gesti칩n de Productos - Aparicio Admin">
    <title>Productos | Aparicio Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <!-- Loading State -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <p>Cargando productos...</p>
    </div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <span class="admin-logo-icon">游볷</span>
                <span>Aparicio</span>
            </div>
            <nav>
                <ul class="admin-nav">
                    <li class="admin-nav-item">
                        <a href="dashboard.html" class="admin-nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="7" height="9"></rect>
                                <rect x="14" y="3" width="7" height="5"></rect>
                                <rect x="14" y="12" width="7" height="9"></rect>
                                <rect x="3" y="16" width="7" height="5"></rect>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="products.html" class="admin-nav-link active">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                                </path>
                            </svg>
                            Productos
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="orders.html" class="admin-nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            Pedidos
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="stats.html" class="admin-nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>
                            Estad칤sticas
                        </a>
                    </li>
                    <li class="admin-nav-item"
                        style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <a href="../index.html" class="admin-nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            Ver Tienda
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#" class="admin-nav-link" id="logout-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            Cerrar Sesi칩n
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <h1 class="admin-title">Productos</h1>
                <button class="btn btn-primary" id="add-product-btn">
                    + Agregar Producto
                </button>
            </div>

            <!-- Search & Filter -->
            <div class="search-section mb-lg">
                <div class="search-bar" style="margin-bottom: 0;">
                    <input type="text" class="search-input" id="search-input" placeholder="Buscar productos...">
                    <select class="form-input" id="category-filter" style="max-width: 200px;">
                        <option value="all">Todas las categor칤as</option>
                        <option value="gaseosas">Gaseosas</option>
                        <option value="agua">Agua</option>
                        <option value="jugos">Jugos</option>
                        <option value="energizantes">Energizantes</option>
                        <option value="deportivas">Deportivas</option>
                    </select>
                </div>
            </div>

            <!-- Products Table -->
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categor칤a</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="products-table">
                        <!-- Products will be inserted here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Agregar Producto</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <form id="product-form">
                <div class="modal-body">
                    <input type="hidden" id="product-id" name="id">

                    <div class="form-group">
                        <label class="form-label" for="product-name">Nombre *</label>
                        <input type="text" class="form-input" id="product-name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="product-category">Categor칤a *</label>
                        <select class="form-input" id="product-category" name="category" required>
                            <option value="">Seleccionar...</option>
                            <option value="gaseosas">Gaseosas</option>
                            <option value="agua">Agua</option>
                            <option value="jugos">Jugos</option>
                            <option value="energizantes">Energizantes</option>
                            <option value="deportivas">Deportivas</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label" for="product-price">Precio *</label>
                            <input type="number" class="form-input" id="product-price" name="price" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="product-stock">Stock *</label>
                            <input type="number" class="form-input" id="product-stock" name="stock" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="product-image">Imagen del Producto</label>
                        <select class="form-input" id="product-image" name="image">
                            <option value="游볷">游볷 Emoji por defecto</option>
                        </select>
                        <div id="image-preview"
                            style="margin-top:12px;text-align:center;padding:16px;background:var(--color-bg);border-radius:8px;min-height:80px;display:flex;align-items:center;justify-content:center;">
                            <span style="font-size:3rem;">游볷</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="product-description">Descripci칩n</label>
                        <textarea class="form-input" id="product-description" name="description" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="save-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Confirmar Eliminaci칩n</h3>
                <button class="modal-close" id="delete-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>쮼st치s seguro de que quieres eliminar este producto?</p>
                <p class="text-muted">Esta acci칩n no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="delete-cancel-btn">Cancelar</button>
                <button type="button" class="btn btn-danger" id="delete-confirm-btn">Eliminar</button>
            </div>
        </div>
    </div>

    <style>
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--color-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #image-preview img {
            max-width: 100px;
            max-height: 100px;
            object-fit: contain;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="../js/data.js"></script>
    <script>
        // Check authentication
        if (!isAdminAuthenticated()) {
            window.location.href = 'index.html';
        }

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            adminLogout();
            window.location.href = 'index.html';
        });

        // DOM Elements
        const productsTable = document.getElementById('products-table');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const productModal = document.getElementById('product-modal');
        const productForm = document.getElementById('product-form');
        const modalTitle = document.getElementById('modal-title');
        const deleteModal = document.getElementById('delete-modal');
        const loadingOverlay = document.getElementById('loading');
        const saveBtn = document.getElementById('save-btn');

        let currentProductId = null;
        let deleteProductId = null;
        let allProducts = [];
        let availableImages = [
            { file: "coca-cola.jpg", name: "Coca-Cola" },
            { file: "sprite.jpg", name: "Sprite" },
            { file: "fanta.jpg", name: "Fanta" },
            { file: "pepsi.jpg", name: "Pepsi" },
            { file: "7up.jpg", name: "7Up" },
            { file: "agua-mineral.jpg", name: "Agua Mineral" },
            { file: "agua-gas.jpg", name: "Agua con Gas" },
            { file: "jugo-naranja.jpg", name: "Jugo Naranja" },
            { file: "jugo-manzana.jpg", name: "Jugo Manzana" },
            { file: "jugo-durazno.jpg", name: "Jugo Durazno" },
            { file: "speed.jpg", name: "Speed" },
            { file: "redbull.jpg", name: "Red Bull" },
            { file: "monster.jpg", name: "Monster" },
            { file: "gatorade.jpg", name: "Gatorade" },
            { file: "powerade.jpg", name: "Powerade" }
        ];

        // Populate image selector on load
        function loadAvailableImages() {
            populateImageSelector();
        }

        // Populate image dropdown
        function populateImageSelector() {
            const select = document.getElementById('product-image');
            select.innerHTML = '<option value="游볷">游볷 Emoji por defecto</option>';
            availableImages.forEach(img => {
                select.innerHTML += `<option value="images/${img.file}">${img.name}</option>`;
            });
        }

        // Update preview when image changes
        document.getElementById('product-image').addEventListener('change', function () {
            updateImagePreview(this.value);
        });

        function updateImagePreview(value) {
            const preview = document.getElementById('image-preview');
            if (value && (value.includes('/') || value.includes('.'))) {
                preview.innerHTML = `<img src="../${value}" alt="Preview" onerror="this.parentElement.innerHTML='<span style=color:red>Imagen no encontrada</span>'">`;
            } else {
                preview.innerHTML = `<span style="font-size:3rem;">${value || '游볷'}</span>`;
            }
        }

        // Initialize
        async function init() {
            await loadAvailableImages();
            allProducts = await getProducts();
            renderProducts();
            loadingOverlay.classList.add('hidden');
        }

        // Render products
        function renderProducts() {
            const search = searchInput.value.toLowerCase();
            const category = categoryFilter.value;

            const filteredProducts = allProducts.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(search);
                const matchesCategory = category === 'all' || p.category === category;
                return matchesSearch && matchesCategory;
            });

            if (filteredProducts.length === 0) {
                productsTable.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No se encontraron productos</td></tr>';
                return;
            }

            productsTable.innerHTML = filteredProducts.map(product => {
                const stockStatus = product.stock === 0 ? 'cancelled' : product.stock <= 10 ? 'pending' : 'delivered';
                const stockLabel = product.stock === 0 ? 'Sin Stock' : product.stock <= 10 ? 'Stock Bajo' : 'En Stock';
                const img = product.image;
                const imgHtml = img && (img.includes('/') || img.includes('.'))
                    ? `<img src="../${img}" style="width:40px;height:40px;object-fit:contain;">`
                    : `<span style="font-size:1.5rem;">${img}</span>`;

                return `
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 12px;">
                ${imgHtml}
                <div>
                  <p style="font-weight: 500; margin: 0;">${product.name}</p>
                  <p style="font-size: 12px; color: var(--color-text-muted); margin: 0;">${product.description || ''}</p>
                </div>
              </div>
            </td>
            <td><span style="text-transform: capitalize;">${product.category}</span></td>
            <td>${formatPrice(product.price)}</td>
            <td>${product.stock}</td>
            <td><span class="badge badge-${stockStatus}">${stockLabel}</span></td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm btn-secondary" onclick="editProduct(${product.id})">Editar</button>
                <button class="btn btn-sm btn-danger" onclick="confirmDelete(${product.id})">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
            }).join('');
        }

        // Open modal for new product
        document.getElementById('add-product-btn').addEventListener('click', () => {
            currentProductId = null;
            modalTitle.textContent = 'Agregar Producto';
            productForm.reset();
            document.getElementById('product-image').value = '游볷';
            updateImagePreview('游볷');
            productModal.classList.add('active');
        });

        // Edit product
        function editProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;

            currentProductId = id;
            modalTitle.textContent = 'Editar Producto';

            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-image').value = product.image;
            updateImagePreview(product.image);
            document.getElementById('product-description').value = product.description || '';

            productModal.classList.add('active');
        }

        // Save product
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';

            const formData = new FormData(productForm);
            const product = {
                id: currentProductId,
                name: formData.get('name'),
                category: formData.get('category'),
                price: parseInt(formData.get('price')),
                stock: parseInt(formData.get('stock')),
                image: formData.get('image') || '游볷',
                description: formData.get('description')
            };

            await saveProduct(product);
            allProducts = await getProducts();

            productModal.classList.remove('active');
            renderProducts();

            saveBtn.disabled = false;
            saveBtn.textContent = 'Guardar';
        });

        // Confirm delete
        function confirmDelete(id) {
            deleteProductId = id;
            deleteModal.classList.add('active');
        }

        // Delete product
        document.getElementById('delete-confirm-btn').addEventListener('click', async () => {
            if (deleteProductId) {
                await deleteProduct(deleteProductId);
                allProducts = await getProducts();
                deleteModal.classList.remove('active');
                deleteProductId = null;
                renderProducts();
            }
        });

        // Close modals
        document.getElementById('modal-close').addEventListener('click', () => {
            productModal.classList.remove('active');
        });

        document.getElementById('cancel-btn').addEventListener('click', () => {
            productModal.classList.remove('active');
        });

        document.getElementById('delete-modal-close').addEventListener('click', () => {
            deleteModal.classList.remove('active');
        });

        document.getElementById('delete-cancel-btn').addEventListener('click', () => {
            deleteModal.classList.remove('active');
        });

        // Close modal on overlay click
        productModal.addEventListener('click', (e) => {
            if (e.target === productModal) {
                productModal.classList.remove('active');
            }
        });

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('active');
            }
        });

        // Search & filter
        searchInput.addEventListener('input', renderProducts);
        categoryFilter.addEventListener('change', renderProducts);

        // Initialize
        init();
    </script>
</body>

</html>