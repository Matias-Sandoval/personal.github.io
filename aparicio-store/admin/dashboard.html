<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard de Administraci√≥n - Aparicio">
    <title>Dashboard | Aparicio Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Loading State -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <p>Cargando dashboard...</p>
    </div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <span class="admin-logo-icon">ü•§</span>
                <span>Aparicio</span>
            </div>
            <nav>
                <ul class="admin-nav">
                    <li class="admin-nav-item">
                        <a href="dashboard.html" class="admin-nav-link active">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="7" height="9"></rect>
                                <rect x="14" y="3" width="7" height="5"></rect>
                                <rect x="14" y="12" width="7" height="9"></rect>
                                <rect x="3" y="16" width="7" height="5"></rect>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="products.html" class="admin-nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                                </path>
                            </svg>
                            Productos
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="orders.html" class="admin-nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            Pedidos
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="stats.html" class="admin-nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>
                            Estad√≠sticas
                        </a>
                    </li>
                    <li class="admin-nav-item"
                        style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <a href="../index.html" class="admin-nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            Ver Tienda
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="#" class="admin-nav-link" id="logout-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            Cerrar Sesi√≥n
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <h1 class="admin-title">Dashboard</h1>
                <p class="text-muted" id="current-date"></p>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">üí∞</div>
                    <div class="stat-info">
                        <h3>Ventas del D√≠a</h3>
                        <p class="stat-value" id="today-sales">$0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon yellow">üì¶</div>
                    <div class="stat-info">
                        <h3>Pedidos Pendientes</h3>
                        <p class="stat-value" id="pending-orders">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">‚úì</div>
                    <div class="stat-info">
                        <h3>Pedidos Hoy</h3>
                        <p class="stat-value" id="today-orders">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red">‚ö†Ô∏è</div>
                    <div class="stat-info">
                        <h3>Stock Bajo</h3>
                        <p class="stat-value" id="low-stock">0</p>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div
                style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <div
                    style="background: var(--color-bg-white); border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: var(--shadow);">
                    <h3 class="mb-md">Ventas de la Semana</h3>
                    <canvas id="sales-chart"></canvas>
                </div>
                <div
                    style="background: var(--color-bg-white); border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: var(--shadow);">
                    <h3 class="mb-md">Productos M√°s Vendidos</h3>
                    <div id="top-products">
                        <!-- Top products will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Recent Orders & Low Stock -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                <!-- Recent Orders -->
                <div class="data-table-container">
                    <div
                        style="padding: var(--spacing-md); border-bottom: 1px solid var(--color-border-light); display: flex; justify-content: space-between; align-items: center;">
                        <h3>Pedidos Recientes</h3>
                        <a href="orders.html" class="btn btn-sm btn-secondary">Ver Todos</a>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            <!-- Recent orders will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Low Stock Products -->
                <div class="data-table-container">
                    <div
                        style="padding: var(--spacing-md); border-bottom: 1px solid var(--color-border-light); display: flex; justify-content: space-between; align-items: center;">
                        <h3>Productos con Stock Bajo</h3>
                        <a href="products.html" class="btn btn-sm btn-secondary">Ver Todos</a>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Stock</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="low-stock-products">
                            <!-- Low stock products will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <style>
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--color-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="../js/data.js"></script>
    <script>
        // Check authentication
        if (!isAdminAuthenticated()) {
            window.location.href = 'index.html';
        }

        const loadingOverlay = document.getElementById('loading');

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            adminLogout();
            window.location.href = 'index.html';
        });

        // Set current date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-AR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Load stats
        async function loadDashboard() {
            const stats = await getStats();
            const orders = await getOrders();

            // Update stat cards
            document.getElementById('today-sales').textContent = formatPrice(stats.todaySales);
            document.getElementById('pending-orders').textContent = stats.pendingOrderCount;
            document.getElementById('today-orders').textContent = stats.todayOrderCount;
            document.getElementById('low-stock').textContent = stats.lowStockCount + stats.outOfStockCount;

            // Sales chart
            const ctx = document.getElementById('sales-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.salesByDay.map(d => d.date),
                    datasets: [{
                        label: 'Ventas',
                        data: stats.salesByDay.map(d => d.sales),
                        backgroundColor: 'rgba(8, 145, 178, 0.8)',
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatPrice(value)
                            }
                        }
                    }
                }
            });

            // Top products
            const topProductsEl = document.getElementById('top-products');
            if (stats.topProducts.length === 0) {
                topProductsEl.innerHTML = '<p class="text-muted text-center">No hay ventas a√∫n</p>';
            } else {
                topProductsEl.innerHTML = stats.topProducts.map((product, index) => `
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--color-border-light);">
            <span style="width: 24px; height: 24px; background: ${index === 0 ? 'var(--color-warning)' : 'var(--color-bg)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${index + 1}</span>
            <div style="flex: 1;">
              <p style="font-weight: 500; margin: 0;">${product.name}</p>
              <p style="font-size: 12px; color: var(--color-text-muted); margin: 0;">${product.quantity} vendidos</p>
            </div>
            <span style="font-weight: 600; color: var(--color-primary-dark);">${formatPrice(product.revenue)}</span>
          </div>
        `).join('');
            }

            // Recent orders
            const recentOrdersEl = document.getElementById('recent-orders');
            const recentOrders = orders.slice(0, 5);
            if (recentOrders.length === 0) {
                recentOrdersEl.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay pedidos a√∫n</td></tr>';
            } else {
                recentOrdersEl.innerHTML = recentOrders.map(order => `
          <tr>
            <td><code style="font-size: 11px;">${order.id}</code></td>
            <td>${order.customer.name}</td>
            <td>${formatPrice(order.total)}</td>
            <td><span class="badge badge-${order.status}">${STATUS_LABELS[order.status]}</span></td>
          </tr>
        `).join('');
            }

            // Low stock products
            const lowStockProductsEl = document.getElementById('low-stock-products');
            const lowStockItems = [...stats.outOfStockProducts, ...stats.lowStockProducts].slice(0, 5);
            if (lowStockItems.length === 0) {
                lowStockProductsEl.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Todo el inventario est√° bien</td></tr>';
            } else {
                lowStockProductsEl.innerHTML = lowStockItems.map(product => `
          <tr>
            <td>${product.image} ${product.name}</td>
            <td>${product.stock}</td>
            <td><span class="badge ${product.stock === 0 ? 'badge-cancelled' : 'badge-pending'}">${product.stock === 0 ? 'Sin Stock' : 'Stock Bajo'}</span></td>
          </tr>
        `).join('');
            }

            // Hide loading
            loadingOverlay.classList.add('hidden');
        }

        loadDashboard();
    </script>
</body>

</html>